name: CI

on:
  # We run CI on pushes to the main branch
  push:
    branches:
      - main
  # and on all pull requests to the main branch
  pull_request:
    branches:
      - main
  # as well as upon manual triggers through the 'Actions' tab of the Github UI
  workflow_dispatch:

jobs:
  test:
    name: Testing on ${{ matrix.os }} with Python ${{ matrix.python-version }} and MPI=${{ matrix.parallel }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        #os: [ubuntu-latest, macos-latest, windows-latest]
        os: [windows-latest]
        python-version: ["3.9"]
        parallel: ["ON", "OFF"]
        exclude:
          - os: windows-latest
            parallel: "ON"

    steps:
      - name: Checking out the repository
        uses: actions/checkout@v3

      - name: Installing system dependencies
        if: matrix.parallel == 'ON' && runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install libopenmpi-dev

      - name: Installing system dependencies
        if: matrix.parallel == 'ON' && runner.os == 'MacOS'
        run: |
          brew install open-mpi

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install sequential Python package
        if: matrix.parallel == 'OFF' && runner.os =='Windows'
        shell: bash
        run: |
          sed -i.bak 's|"mpi4py",||g' pyproject.toml
          python -m pip install -v .[tests,jupyter] || ls D:/a/parafields/parafields/_skbuild/win-amd64-3.9/cmake-build/core-inst
        env:
          CMAKE_ARGS: "-DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++ -DFORCE_SEQUENTIAL=ON"

      - name: Install parallel Python package
        if: matrix.parallel == 'ON'
        run: |
          python -m pip install -v .[tests,jupyter]
        env:
          CMAKE_ARGS: "--debug-output -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++"

      - name: Run test suite
        run: |
          python -m pytest

      - name: Run parallel test suite
        if: matrix.parallel == 'ON'
        run: |
          mpirun --oversubscribe -np 4 python -m pytest --only-mpi
